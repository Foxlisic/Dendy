Вариация Денди для DE0: Cyclone V
Блочной памяти 308 Кб

Распределение памяти
---------------------

$0000-$07FF 2k      ОЗУ
  000-  0FF         * Нулевая страница
  100-  1FF         * Аппаратный стек
  200-  7FF         * Пользовательские данные

$0800-$1FFF 6k      ОЗУ [зеркала]
$2000-$2007 8       Видеорегистры
$2008-$3FFF $1FF8   Видеорегистры [1023 зеркал]
$4000-$4017 32      Аудиорегистры и DMA
$4018-$4FFF $0FE8   Не используется
$5000-$5FFF 4k      Расширение ROM
$6000-$7FFF 8k      WRAM [SRAM]
$8000-$BFFF 16K     PRG-ROM 1
$C000-$FFFF 16K     PRG-ROM 0

      $FFFA         NMI (VBlink) Поступает с видеопроцессора
      $FFFC         RESET
      $FFFE         IRQ/BRK

Распределение видеопамяти
------------------------------------------------------------------------

$0000-$0FFF 4k      CHR-ROM Знакогенератор 0 (На картридже)
$1000-$1FFF 4k      CHR-ROM Знакогенератор 1 (На картридже)
$2000-$23BF $3C0    VRAM Экранная страница 0 – Символы  (В приставке)
$23C0-$23FF $40     VRAM Экранная страница 0 – Атрибуты (В приставке)
$2400-$26BF $3C0    VRAM Экранная страница 1 – Символы  (В приставке)
$27C0-$27FF $40     VRAM Экранная страница 1 – Атрибуты (В приставке)
$2800-$2BBF $3C0    VRAM Экранная страница 2 – Символы  (На картридже)
$2BC0-$2BFF $40     VRAM Экранная страница 2 – Атрибуты (На картридже)
$2C00-$2FBF $3C0    VRAM Экранная страница 3 – Символы  (На картридже)
$2FC0-$2FFF $40     VRAM Экранная страница 3 – Атрибуты (На картридже)
$3000-$3EFF $F00    VRAM Зеркала $2000-2EFF
$3F00-$3F0F $10     Палитра фона (в регистрах PPU)
$3F10-$3F1F $10     Палитра спрайтов (в регистрах PPU)
$3F20-$3FFF $E0     Не используются

Тайминги https://www.nesdev.org/w/images/default/4/4f/Ppu.svg
------------------------------------------------------------------------

3Т PPU = 1T CPU

___|/```\___/```\___/```\___|/```\___/```\___/```\___|/```\ PPU
___|/```\___________________|/```\___________________|/```\ CPU

Ширина  0..340 [341 столбца на кадр]

    0  ..255    Видимая часть
    255..340    Вне кадра

Высота  0..261 [262 линии на кадр]

    0  ..239    Видимая часть
    240..261    Вне кадра
    241:0       Установка VBlank=1
    261:0       Сброс VBlank=1, Sprite0, Overflow

VGA размер 800 x 525

Скроллинг
------------------------------------------------------------------------
https://www.nesdev.org/wiki/PPU_scrolling

Видеопроцессор имеет внутренний регистр v (и t), а также FineX.
FineX это отдельный 3х битный регистр, который показывает, какая точка
сейчас рисуется (от 0 до 7) у считанного 8-битного значения CHR.

FEDC BA 98765 43210
0yyy NN YYYYY XXXXX   Регистр V или T
 ||| || ||||| +++++-- Coarse X scroll
 ||| || +++++-------- Coarse Y scroll
 ||| ++-------------- Nametable
 +++----------------- FineY scroll

HBlank начинается после 256-й точки и заканчивается на 320,
когда первый тайл следующей линии начинает считываться.

== Инкремент X ==

if ((v & 0x001F) == 31) // if coarse X == 31
  v &= ~0x001F          // coarse X = 0
  v ^= 0x0400           // switch horizontal nametable
else
  v += 1                // increment coarse X

== Инкремент Y ==

Y скроллинг в регистре `v` увеличивается на строке Y=256.

if ((v & 0x7000) != 0x7000)        // Если FINEY < 7
  v += 0x1000                      // то увеличить FINEY++
else

  v &= ~0x7000                     // FINEY = 0
  int y = (v & 0x03E0) >> 5        // Получение Y = [9:5] грубого скролла Y
  if (y == 29)
    y = 0                          // coarse Y = 0
    v ^= 0x0800                    // switch vertical nametable
  else if (y == 31)
    y = 0                          // coarse Y = 0, nametable not switched
  else
    y += 1                         // increment coarse Y

  # Записать грубый скроллинг Y в V
  v = (v & ~0x03E0) | (y << 5)
